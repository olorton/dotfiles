#!/usr/bin/env bash

DOTFILES_ROOT=$(cd $(dirname "${BASH_SOURCE[0]}") && cd .. && pwd)

ANSI_RESET="\033[0m"
FG_BLACK="\033[30m"
FG_RED="\033[31m"
FG_GREEN="\033[32m"
FG_YELLOW="\033[33m"
FG_BLUE="\033[34m"
FG_PURPLE="\033[35m"
FG_CYAN="\033[36m"
FG_LIGHT_GRAY="\033[37m"

symlink_dotfile () {
    SOURCE="${1}"
    TARGET="${2}"

    info_message=""

    if [ ! -L "${TARGET}" ] && [ -f "${TARGET}" ]; then
        info_message="${FG_BLUE} (File backed up to: ${TARGET}.backup)"
        mv "${TARGET}" "${TARGET}.backup"
    elif [ -L "${TARGET}" ] && [ -f "${TARGET}" ]; then
        info_message="${FG_LIGHT_GRAY} (replaced)"
        rm -f "${TARGET}"
    elif [ -L "${TARGET}" ] && [ -d "${TARGET}" ]; then
        info_message="${FG_LIGHT_GRAY} (replaced)"
        rm -f "${TARGET}"
    elif [ ! -L "${TARGET}" ] && [ -d "${TARGET}" ]; then
        info_message="${FG_BLUE} (Dir backed up to: ${TARGET}.backup)"
        mv "${TARGET}" "${TARGET}.backup"
    elif [ -e "${TARGET}" ]; then
        printf "${FG_RED}Cannot overwrite because the destination exists, and is not a file or a link: ${TARGET}\n${ANSI_RESET}"
        exit 1
    fi
    
    # Ensure target's directories exists
    mkdir -p $(dirname "${TARGET}")

    # Create symlink
    ln -s "${DOTFILES_ROOT}/${SOURCE}" "${TARGET}"
    if [ -L "${TARGET}" ] && [ -f "${TARGET}" ]; then
        printf "${FG_GREEN}${SOURCE} -> ${TARGET/$HOME/~}${info_message}\n${ANSI_RESET}"
    fi
}

#symlink_dotfile cmus/rc ~/.config/cmus/rc
symlink_dotfile git/gitconfig.symlink ~/.gitconfig
symlink_dotfile git/gitignore_global ~/.gitignore_global
symlink_dotfile tig/tigrc.symlink ~/.tigrc
symlink_dotfile tmux/tmux.conf.symlink ~/.tmux.conf
#mkdir -p ~/.config/nvim/tmp/backup # TODO - should my new vim config do stuff with this?
#mkdir -p ~/.config/nvim/tmp/undo # TODO - should my new vim config do stuff with this?
symlink_dotfile nvim ~/.config/nvim
symlink_dotfile zsh/zshrc.symlink ~/.zshrc
symlink_dotfile alacritty/main.yml ~/.config/alacritty/main.yml
[[ $OSTYPE == "darwin"* ]] && symlink_dotfile alacritty/mac.yml ~/.config/alacritty/os_overrides.yml
[[ $OSTYPE == "linux"* ]] && symlink_dotfile alacritty/linux.yml ~/.config/alacritty/os_overrides.yml
symlink_dotfile alacritty/colours ~/.config/alacritty/colours
symlink_dotfile alacritty/local.yml ~/.config/alacritty/local.yml
symlink_dotfile alacritty/alacritty.yml ~/.config/alacritty/alacritty.yml
symlink_dotfile pyenv/python-version ~/.python-version
[[ $OSTYPE == "linux"* ]] && symlink_dotfile tmux/tmux-linux.conf.symlink ~/.tmux.os.conf
[[ $OSTYPE == "darwin"* ]] && symlink_dotfile tmux/tmux-macosx.conf.symlink ~/.tmux.os.conf
#[[ $OSTYPE == "darwin"* ]] && [ -d ~/Library/Application\ Support/Sublime\ Text ] && symlink_dotfile sublime_text/User/ ~/Library/Application\ Support/Sublime\ Text/Packages/User
symlink_dotfile direnv/direnvrc.symlink ~/.direnvrc
#[[ $OSTYPE == "linux"* ]] && symlink_dotfile i3/config ~/.config/i3/config
